<?php

namespace MavenShop\Admin\Controllers;

class Categories extends \MavenShop\Admin\Controllers\ShopAdminController {

	public function __construct() {
		parent::__construct();
	}

	public function admin_init() {
		
	}

	public function showForm() {

		/* $venueManager = new \MavenEvents\Core\VenueManager();

		  $venues = $venueManager->getAll();

		  $this->addJSONData('cachedVenues', $venues); */

		$this->getOutput()->setTitle( $this->__( "Categories" ) );

		$this->getOutput()->loadAdminView( "categories" );
	}

	public function cancel() {
		
	}

	public function save() {
		
	}

	public function showList() {
		
	}

	public function categoryEntryPoint() {
		try {
			$event = $this->getRequest()->getProperty( 'event' );

			$manager = new \MavenShop\Core\CategoryManager();

			switch ( $event ) {
				case 'create':
					$data = $this->getRequest()->getProperty( 'data' );

					$category = new \MavenShop\Core\Domain\Category();

					$category->load( $data );

					$manager->addCategory( $category );

					$this->getOutput()->sendData( $category->toArray() );

					break;

				case 'read':

					$modelId = $this->getRequest()->getProperty( 'id' );

					if ( $modelId ) {
						try {
							$category = $manager->get( $modelId );
							$this->getOutput()->sendData( $category->toArray() );
						} catch ( \Maven\Exceptions\MavenException $ex ) {
							$this->getOutput()->sendError( $ex->getMessage() );
						}
					} else {
						$data = $this->getRequest()->getProperty( 'data' );

						$top = $this->getRequest()->getProperty( 'top' );
						$skip = $this->getRequest()->getProperty( 'skip' );

						$filter = new \MavenShop\Core\Domain\CategoryFilter();

						if ( key_exists( 'name', $data ) && $data[ 'name' ] )
							$filter->setName( $data[ 'name' ] );


						$page = $data[ 'page' ] - 1; //We use 0-based pages
						$perPage = $data[ 'per_page' ];
						$sortBy = '';
						if ( $data && key_exists( 'sort_by', $data ) )
							$sortBy = \Maven\Core\Utils::unCamelize( $data[ 'sort_by' ], '_' );

						$order = '';
						if ( $data && key_exists( 'order', $data ) )
							$order = $data[ 'order' ];
						//var_dump($data);
						$intances = $manager->getAll( $filter, $sortBy, $order, ($page * $perPage ), $perPage );
						$count = $manager->getCount( $filter );

						$response = array();
						foreach ( $intances as $row ) {
							$response[] = $row->toArray();
						}

						$out[] = array( 'total_entries' => intval( $count ) );
						$out[] = $response;

						$this->getOutput()->sendData( $out );
					}
					break;

				case 'update':

					$data = $this->getRequest()->getProperty( 'data' );

					$category = $manager->addCategory( $data );

					$this->getOutput()->sendData( $category->toArray() );

					break;

				case 'delete':
					$modelId = $this->getRequest()->getProperty( 'id' );

					$manager->delete( $modelId );

					//Empty response
					$this->getOutput()->sendData( 'deleted' );

					break;
			}
		} catch ( Exception $ex ) {
			$this->getOutput()->sendError( $ex->getMessage() );
		}
	}

}
